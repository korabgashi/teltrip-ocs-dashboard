import { NextResponse } from 'next/server';const API_URL='https://ocs-api.esimvault.cloud/v1';const OCS_TOKEN=process.env.OCS_TOKEN;const ALLOWED=(process.env.OCS_ALLOWED_ACCOUNTS||'3771').split(',').map(a=>Number(a.trim())).filter(Boolean);const MOCK={result:{subscribers:[{subscriberId:1001,iccid:'8988307000000000001',status:'ACTIVE',prepaidpackagetemplatename:'EU 5GB 7d',tsactivationutc:'2025-08-10T10:00:00Z',tsexpirationutc:'2025-08-17T10:00:00Z'}],total:1}};export async function POST(req){try{const body=await req.json();const {accountId,limit=200,offset=0}=body||{};if(!ALLOWED.includes(Number(accountId)))return NextResponse.json({error:'Forbidden for this account'},{status:403});if(!OCS_TOKEN){return NextResponse.json(MOCK)}const ocsBody={listSubscriber:{accountId:Number(accountId),limit,offset}};const r=await fetch(`${API_URL}?token=${OCS_TOKEN}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(ocsBody),cache:'no-store'});if(!r.ok){const text=await r.text();return NextResponse.json({error:`OCS error: ${r.status} - ${text.slice(0,300)}`},{status:502})}const data=await r.json();return NextResponse.json(data)}catch(e){return NextResponse.json({error:String(e)},{status:500})}}